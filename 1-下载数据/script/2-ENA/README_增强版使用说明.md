# ASCP批量下载脚本使用说明

## 功能特性

1. **批量下载**: 自动读取配置文件中的URL列表，批量下载BAM和BAI文件
2. **断点续跑**: 支持中断后重新运行，自动检查已存在的文件，只下载缺失的文件
3. **智能检查**: 检查文件是否存在且非空，确保下载完整性
4. **详细日志**: 记录下载过程和结果，便于问题排查
5. **进度显示**: 实时显示下载进度和状态
6. **错误处理**: 记录失败的下载，支持重试

## 文件说明

- **脚本文件**: `1-0-ascp下载BAM_增强版.sh`
- **配置文件**: 
  - `conf/PRJEB49419_bam.url` - BAM文件URL列表
  - `conf/PRJEB49419_bam_bai.url` - BAI文件URL列表
- **输出目录**: `/mnt/d/迅雷下载/古代DNA/data/`
- **日志文件**: `/mnt/d/迅雷下载/古代DNA/data/download.log`
- **失败记录**: `/mnt/d/迅雷下载/古代DNA/data/failed_downloads.txt`

## 使用方法

### 1. 基本使用
```bash
cd "/mnt/f/OneDrive/文档（科研）/脚本/Download/9-My-Toolskit/1-下载数据/script/2-ENA/script/"
./1-0-ascp下载BAM_增强版.sh
```

### 2. 断点续跑
如果下载过程中断，只需重新运行相同命令：
```bash
./1-0-ascp下载BAM_增强版.sh
```
脚本会自动检查输出目录，跳过已下载的文件。

### 3. 查看下载状态
- 查看实时日志：`tail -f /mnt/d/迅雷下载/古代DNA/data/download.log`
- 检查失败文件：`cat /mnt/d/迅雷下载/古代DNA/data/failed_downloads.txt`
- 统计已下载文件：`ls -la /mnt/d/迅雷下载/古代DNA/data/ | wc -l`

## 脚本工作流程

1. **初始化**: 创建输出目录，清理日志
2. **环境检查**: 验证ascli命令可用性，测试服务器连接
3. **文件扫描**: 扫描输出目录，统计已存在的文件
4. **批量下载**: 
   - 读取BAM URL文件，逐个下载
   - 读取BAI URL文件，逐个下载
   - 对每个文件检查是否已存在，存在则跳过
5. **结果统计**: 显示下载统计信息和失败列表

## 配置参数

脚本顶部的配置参数可以根据需要修改：

```bash
BAM_URL_FILE="..."     # BAM文件URL列表路径
BAI_URL_FILE="..."     # BAI文件URL列表路径  
OUTPUT_DIR="..."       # 输出目录路径
LOG_FILE="..."         # 日志文件路径
FAILED_FILE="..."      # 失败记录文件路径
```

## 注意事项

1. **网络连接**: 确保网络连接稳定，可以访问EBI FTP服务器
2. **存储空间**: 确保输出目录有足够的存储空间
3. **权限**: 确保对输出目录有写权限
4. **中断处理**: 使用Ctrl+C可以安全中断脚本
5. **重试机制**: 失败的文件会记录在failed_downloads.txt中，重新运行脚本会尝试重新下载

## 故障排除

1. **ascli命令未找到**: 请检查ascli是否正确安装和配置
2. **连接失败**: 检查网络连接和EBI服务器状态
3. **权限错误**: 检查输出目录的写权限
4. **文件损坏**: 脚本会检查文件完整性，损坏的文件会被重新下载

## 输出示例

```
2025-10-11 10:30:15 [INFO] === 开始批量下载 ===
2025-10-11 10:30:15 [INFO] 输出目录: /mnt/d/迅雷下载/古代DNA/data/
2025-10-11 10:30:15 [INFO] 输出目录中已存在 5 个文件
2025-10-11 10:30:16 [INFO] 开始处理 BAM 文件列表...
2025-10-11 10:30:16 [INFO] 进度: 1/28
2025-10-11 10:30:16 [INFO] 文件已存在，跳过: 10337.bam
2025-10-11 10:30:17 [INFO] 进度: 2/28
2025-10-11 10:30:17 [INFO] 开始下载: 10338.bam
2025-10-11 10:30:45 [SUCCESS] 下载成功: 10338.bam
...
2025-10-11 11:15:30 [INFO] === 下载完成 ===
2025-10-11 11:15:30 [INFO] 新下载文件: 23
2025-10-11 11:15:30 [INFO] 总文件数: 56
```